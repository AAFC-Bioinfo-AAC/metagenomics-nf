manifest {
    description = 'Devin Holman and Arun Kommadath Metagenomic workflow (AAFC)'
}

conda_env = "/isilon/sherbrooke-rdc/users/brouardjs/metagenomic_nf/envs"

profiles {
    local {
        params {
            genome           = "$baseDir/data/genomes/bowtie_genome_index/cow/"
            genome_basename  = "cow"      // e.g. cow in cow.1.bt2, cow.2.bt2, cow.rev.1.bt2, cow.rev.2.bt2
            reads            = "$baseDir/data/mini_reads/*_R{1,2}.fastq.gz"
            aln              = "$baseDir/data/aln/*.bam"
            results          = "$baseDir/my_results"
            kaiju_db         = "/mnt/sdb/databases/kaiju_db_nr_euk_20230223"        
            kaiju_merge_script = "$baseDir/src/merge_tax_files.R"
            chocophlan_db    = "$baseDir/db/humann3/chocophlan"
            uniref_db        = "$baseDir/db/humann3/uniref"
            metaphlan_db     = "$baseDir/db/humann3/metaphlan_vJan21"
            gtdb_db          = "?"   
        }
	    process {
            executor = 'local'
            memory = 6.GB
            errorStrategy = 'finish'
            withLabel: mem_large { memory = 24.GB }
            withLabel: mem_xlarge { memory = 128.GB }    
            withName: QUALITY_FILTERING {conda = "$conda_env/fastp'"}
            withName: BOWTIE2 {conda = "$conda_env/bowtie2"}
	        withName: SAM2BAM {conda = "$conda_env/samtools"}
            withName: SORTBAM {conda = "$conda_env/samtools"}
            withName: OUTPUT_UNALIGNED_READS {conda = "$conda_env/bedtools"}
            withName: 'KAIJU|KAIJU_TAX_TABLE|KAIJU_FULL_TAX_TABLE' {
                conda = "$conda_env/kaiju"
                memory = 64.GB
            }
            withName: MERGE_TAX_FILES {conda = "$conda_env/R"}
        }
    }
    biocluster {
        params {
            genome           = "$baseDir/data/genomes/bowtie_genome_index/cow/"
            genome_basename  = "cow"      // e.g. cow in cow.1.bt2, cow.2.bt2, cow.rev.1.bt2, cow.rev.2.bt2
            pseudobins       = "$baseDir/data/pseudo_bins/*.fa"
            reads            = "$baseDir/data/reads/*_R{1,2}.fastq.gz"
            aln              = "$baseDir/data/aln/*.bam"
            results          = "$baseDir/my_results"
            kaiju_db         = "/isilon/common/reference/databases/kaiju_db/kaiju_db_nr_euk_20230223"
            kaiju_merge_script = "$baseDir/src/merge_tax_files.R"
            chocophlan_db    = "$baseDir/data/humann3/chocophlan"
            uniref_db        = "$baseDir/data/uniref"
            metaphlan_db     = "$baseDir/data/humann3/metaphlan_vJan21"
            checkm2_db       = "$baseDir/data/CheckM2_database/uniref100.KO.1.dmnd"
            gtdb_db          = "/isilon/sherbrooke-rdc/users/brouardjs/db/gtdb/release207_v2"
            kraken2          = "/isilon/common/reference/databases/kraken2_ncbi_nt/kraken2_ncbi_nt_20211029"
        }  
	    process {
            executor = 'sge'
            memory = 6.GB
            penv = 'smp'
            errorStrategy = 'finish'
            withLabel: mem_large { memory = 24.GB }
            withLabel: mem_xlarge { memory = 128.GB }    
            withName: QUALITY_FILTERING {conda = "$conda_env/fastp"}
            withName: BOWTIE2 {conda = "$conda_env/bowtie2"
                               memory = 128.GB
                               cpus = 8
            }
	        withLabel: samtools {conda = "$conda_env/samtools"}
            withName: OUTPUT_UNALIGNED_READS {conda = "$conda_env/bedtools"}
            withName: 'KAIJU|KAIJU_TAX_TABLE|KAIJU_FULL_TAX_TABLE' {
                conda = "$conda_env/kaiju"
                memory = 128.GB
                cpus = 40
            
            }
            withName: MERGE_TAX_FILES {conda = "$conda_env/R"}
            withName: 'HUMANN.*' { conda = "$conda_env/biobakery3"}
            withLabel: megahit {conda = "$conda_env/megahit"
                                memory = 512.GB
                                cpus = 30
            } 
            withLabel: metabat2 {conda = "$conda_env/metabat2"
                                 memory = 64.GB
                                 cpus = 30
            }
            withLabel: checkm {conda = "$conda_env/checkm2"
                                memory = 64.GB
                                cpus = 20
            }
            withName: DREP {conda = "$conda_env/drep2"}
            withName: QUAST {conda = "$conda_env/quast"
                             memory = 64.GB
                             cpus = 40
            }
            withName: GTDB_TK {conda = "$conda_env/gtdbtk-2.1.1"
                               memory = 64.GB
                               cpus = 40
            
            }
            withName: PHYLOPHLAN {conda = "$conda_env/phylophlan"
                             memory = 64.GB
                             cpus = 40
            
            }
            
            withName: COVERM {conda = "$conda_env/coverm"}
            withName: 'KRAKEN2|COMBINE_KRAKEN2|BRACKEN' {conda = "$conda_env/kraken2"
                               memory = 64.GB
                               cpus = 40
            
            }
            
        }
    }
}
